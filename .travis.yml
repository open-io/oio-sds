sudo: required
dist: xenial
language: c

addons:
  apt:
    sources:
    - sourceline: 'deb http://archive.ubuntu.com/ubuntu/ xenial-backports main restricted universe multiverse'
    - sourceline: 'deb http://mirror.openio.io/pub/repo/openio/sds/18.04/ubuntu/ xenial/'
      key_url: 'http://mirror.openio.io/pub/repo/openio/APT-GPG-KEY-OPENIO-0'

install:
  - sudo apt-get update -qq
  - sudo apt-get install -y -qq sudo $(awk '{print $1}' ci/deps-ubuntu-xenial.txt)
  - ./ci/install-user-deps.sh $HOME/oio
  - sudo bash -c "echo '/tmp/core.%p.%E' > /proc/sys/kernel/core_pattern"
  - mkdir /tmp/oio
  - git fetch --tags
  - git submodule update --init --recursive

env:
  global:
  - CMAKE_OPTS="-DENABLE_CODECOVERAGE=on -DCMAKE_INSTALL_PREFIX=/tmp/oio -DLD_LIBDIR=lib -DZK_LIBDIR=/usr/lib -DZK_INCDIR=/usr/include/zookeeper -DAPACHE2_LIBDIR=/usr/lib/apache2 -DAPACHE2_INCDIR=/usr/include/apache2 -DAPACHE2_MODDIR=/tmp/oio/lib/apache2/module"
  - G_DEBUG=fatal_warnings
  - G_DEBUG_LEVEL=W
  - ZK=127.0.0.1:2181
  - LD_LIBRARY_PATH=/tmp/oio/lib
  - PKG_CONFIG_PATH=/tmp/oio/lib/pkgconfig

jobs:
  fast_finish: true
  include:
    - stage: Fail Fast tests
      script: ./ci/travis-failfast.sh
      name: Copyright, Release build, SDK build
    - script: ./ci/travis-unit.sh
      name: C unit/func, Python unit/pep8
    - stage: Functional tests (fast)
      script: ./ci/travis-suites.sh
      env: TEST_SUITE=slave
    - script: ./ci/travis-suites.sh
      env: TEST_SUITE=cli
    - script: ./ci/travis-suites.sh
      env: TEST_SUITE=worm
    - stage: Functional tests
      script: ./ci/oio-travis-suites.sh
      env: TEST_SUITE=single,webhook
    - script: ./ci/travis-suites.sh
      env: TEST_SUITE=repli,go-rawx
    - script: ./ci/travis-suites.sh
      env: TEST_SUITE=ec
    - script: ./ci/travis-suites.sh
      env: TEST_SUITE=3copies
    - script: ./ci/travis-suites.sh
      env: TEST_SUITE=small-cache,fsync
    - script: ./ci/travis-suites.sh
      env: TEST_SUITE=3copies,with-service-id
    - script: ./ci/travis-suites.sh
      env: TEST_SUITE=ec,with-random-service-id
    - script: ./ci/travis-suites.sh
      env: TEST_SUITE=rebuilder,with-service-id
    - script: ./ci/travis-suites.sh
      env: TEST_SUITE=multi-beanstalk
    - script: ./ci/travis-suites.sh
      env: TEST_SUITE=mover,with-service-id

after_success:
  - ./ci/post-success.sh
after_failure:
  - ./ci/post-failure.sh
